<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>

    <!-- Material Cdn-->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Stylesheet-->
    <link rel="stylesheet" href="./overall.css">

  <style>
    
    main {
      flex: 1;
      display: block;
      min-width: 0;
    }


    .notify_container {
      max-width: 1200px;
      margin: 0 auto;
      /* background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); */
      padding: 20px;
      margin-top: 10px;
      /* margin-right: -90px; */
      margin-bottom: 10px;
    }

    .filters select {
        appearance: none; /* Remove default dropdown arrow */
        -webkit-appearance: none; /* For WebKit browsers like Safari */
        -moz-appearance: none; /* For Firefox */

        background-color: #fff;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='gray' class='bi bi-caret-down-fill' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14l-4.796-5.481C1.885 5.239 2.563 4 3.705 4h8.59c1.142 0 1.82 1.239 1.254 1.659l-4.796 5.481a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px 16px; /* Size of the custom dropdown arrow */

        padding: 8px 35px 8px 12px; /* Padding to make room for the arrow */
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;

        /* Additional styling for the select dropdown */
        width: 100%; /* Make sure it takes full width of its container */
        max-width: 300px; /* Optional, set a max width */
    }

    

    h1{
      color: #2c3e50;
      border-bottom: 1px solid #c9c7c7;
      padding-bottom: 10px;
      margin-bottom: 30px;
      margin-top: 60px;
      margin-right: -350px;
      
    }

    .tabs{
      display: flex;
      margin-bottom: 20px;
    }

    .tab{
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }

    .tab.active{
      background: #266824;
      color: white;
    }

    .tab-content{
      margin-top: -20px;
      display: none;
      background: white;
      border-radius: 0 8px 8px 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-top: 1px solid #266824;
    }

    .tab-content.active{
      display: block;
    }

    #template-name {
        color: black;
        border: 1px solid #979797;
        padding: 10px;
        border-radius: 4px;
        font-size: 13px;
        width: 100%;
    }

    #template-content {
        color: black;
        border: 1px solid #979797;
        padding: 10px;
        border-radius: 4px;
        font-size: 13px;
        width: 100%;
    }

    .form-group{
      margin-bottom: 15px;
    }

    label{
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    select, textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }

    textarea {
      min-height: 80px;
      max-width: 100%;
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      resize: vertical;
      overflow-wrap: break-word;
      box-sizing: border-box;
    }

    button {
      background: #266824;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.2);
      transition: 0.2s ease-in-out;
    }

    button:hover {
      background: #2b902b;
    }

    button.danger{
      background: #e74c3c;
      color: white;
    }

    button.danger:hover{
      background: #c0392b;
    }

    #start-date{
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #c9c7c7;
    }

    #end-date{
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #c9c7c7;
    }

    #clear-filters-btn{
      position: relative;
      z-index: 10;
    }

    .table-container{
      height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: block;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td{
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th{
      background-color: #f8f9fa ;
      font-weight: bold;
      font-size: 13px;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover{
      background-color: #f5f5f5;
    }

    th:nth-child(1), td:nth-child(1) {
      width: 13%;
    }

    th:nth-child(2), td:nth-child(2) {
      width: 12%;
      text-align: center;
    }

    tbody td:nth-child(2) {
      font-size: 13px;
    }

    th:nth-child(3), td:nth-child(3) {
      width: 75%;
    }


    .status-delivered {
        color: #27ae60;
        font-weight: bold;
    }
        
    .status-pending {
        color: #f39c12;
        font-weight: bold;
    }
    
    .status-failed {
        color: #e74c3c;
        font-weight: bold;
    }

    #template-list{
      list-style: none;
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
    }

    #template-list li{
      background: #f9f9f9;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      border-left: 4px solid #2db250;
    }

    #template-list li strong{
      font-size: 15px;
    }

    #template-list li p{
      margin: 5px 0;
      white-space: pre-wrap;
      padding-top: 15px;
    }

    #template-list li button{
      margin-top: 10px;
    }

    .bottom{
      margin-top: 130px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .bottom .title{
      margin-bottom: 10%;
      border-bottom: 1px solid #dacece;

    }

    #history{
      margin-right: -350px;
    }

    .filter-date{
      margin-left: 10px;
    }

    .filter-date h3{
      font-size: 13px;
      padding-bottom: 6px;
    }

    #start-date{
      padding: 6px;
    }

    #end-date{
      padding: 6px;
    }

    .status-user {
      color: rgb(173, 14, 173);
      font-weight: bold;
    }

    .status-collector {
      color: rgb(51, 161, 154);
      font-weight: bold;
    }


  </style>

</head>
<body>
    <div class="container">
        <aside>
            <div class="top">
                <div class="logo">
                    <img src="./images/logo.JPG" alt="">
                    <h2>PO<span class="dGreen">YO</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-symbols-outlined">close</span>
                </div>
            </div>

            <div class="sidebar" id="clicked">
                <a href="index.html" class="" id="dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <h3>Dashboard</h3>
                </a>
                <a href="user_management.html">
                  <span class="material-symbols-outlined">manage_accounts</span>
                  <h3>User Management</h3>
                </a>
                <a href="feedback.html">
                  <span class="material-symbols-outlined">feedback</span>
                  <h3>Feedback</h3>
                </a>
                <a href="chat_support.html" id="feedback-support" class="">
                  <span class="material-symbols-outlined">support_agent</span>
                  <h3>Customer Support</h3>
                </a>
                <a href="notify.html" class="active" id="messages">
                    <span class="material-symbols-outlined">notifications</span>
                    <h3>Notifications</h3>
                    <!-- <span class="message-count">12</span> -->
                </a>
                <a href="delivery.html" class="" id="settings">
                    <span class="material-symbols-outlined">local_shipping</span>
                    <h3>Delivery</h3>
                </a>
                <a href="#" class="" id="">
                    <span class="material-symbols-outlined">logout</span>
                    <h3>Logout</h3>
                </a>
            </div>
        </aside>

        <!---------------------- END OF ASIDE ---------------------->
        <main>
          <div class="notify_container">
            <h1>Notification Center</h1>

            <div class="tabs">
              <div class="tab active" onclick="openTab(event, 'templates')">Templates</div>
              <div class="tab" onclick="openTab(event,'history')">History</div>
            </div>

            <!-- Teplates Tab -->
            <div id="templates" class="tab-content active">
              <h2 style="padding-bottom: 30px;">Create New Template</h2>
              <div class="form-group">
                <label for="template-name" style="font-size: 15px;">Template Name</label>
                <input type="text" id="template-name" placeholder="e.g. Pickup Reminder">
              </div>

              <div class="form-group">
                <label for="template-content" style="font-size: 15px; margin-top: 30px;">Content</label>
                <textarea id="template-content" placeholder="Template content..."></textarea>
              </div>

              <button onclick="saveTemplate()">Save Template</button>
              <button class="danger" onclick="clearTemplateForm()">Clear</button>


              <!-- <h2>Saved Templates</h2>
              <ul id="template-list"></ul> -->
            </div>

            <!-- History Tab -->
            
            <div id="history" class="tab-content">

              <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 15px;">
                <!-- Date filters on the left -->
                <div style="display: flex; gap: 20px; flex-grow: 1;" class="filter-date">
                  <div>
                    <h3 style="margin: 0;">Start Date:</h3>
                    <input type="date" id="start-date" onchange="filterHistory()" />
                  </div>
              
                  <div>
                    <h3 style="margin: 0;">End Date:</h3>
                    <input type="date" id="end-date" onchange="filterHistory()" />
                  </div>

                  <div class="filters">
                    <h3>Recipient:</h3>
                    <select id="role-filter" onchange="filterHistory()">
                        <option value="">All</option>
                        <option value="User">User</option>
                        <option value="Collector">Collector</option>
                    </select>
                  </div>
                </div>

                <button id="clear-filters-btn" onclick="clearFilters()"
                  style="padding: 8px 12px; background: #888; color: white; border: none; border-radius: 4px; white-space: nowrap;">
                  Clear Filters
                </button>

              </div>
              
              
              
              <div style="display: flex; align-items: center; margin-top: 18px; margin-bottom: 15px; gap: 10px;">
                <span class="material-symbols-outlined" style="padding-left: 8px;">search</span>
                <input 
                  type="text" 
                  id="history-search" 
                  placeholder="Search messages..." 
                  onkeyup="filterHistory()" 
                  style="padding: 8px; width: 75%; border: 1px solid #ddd; border-radius: 4px;"
                >
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Recipient</th>
                      <th>Message</th>
                    </tr>
                  </thead>
                  <tbody id="history-table">
                    <!-- Filled by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          



        </main>

        <!---------------------- END OF MAIN ---------------------->
        <div class="right">
            <div class="top">
                <button id="menu-btn">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="theme-toggler">
                    <span class="material-symbols-outlined active">light_mode</span>
                    <span class="material-symbols-outlined">dark_mode</span>
                </div>
                <div class="profile">
                    <div class="info">
                        <p>Hey,</p>
                        <b style="text-align: center;">Admin</b>
                    </div>
                    <div class="profile-photo">
                        <img src="./images/admin.webp" alt="" class="pic">
                    </div>
                </div>
            </div>
            <div class="bottom" id="saved-templates-container">
              <h2 class="title">Saved Templates</h2>
              <ul id="template-list"></ul>
            </div>
            
            
        </div>
    </div>

    <script type="module">
      import { db } from './firebase-config.js';
      import {
        collection, getDocs, addDoc, deleteDoc, doc, setDoc
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
      let templates = [];
      let editingTemplateId = null;
    
      document.addEventListener('DOMContentLoaded', async () => {
        await loadTemplatesFromFirestore();
        loadTemplates();
        loadHistory();
      });
    
      async function loadTemplatesFromFirestore() {
        templates = [];
        const querySnapshot = await getDocs(collection(db, "templates"));
        querySnapshot.forEach((docSnap) => {
          templates.push({ id: docSnap.id, ...docSnap.data() });
        });
      }
    
      function loadTemplates() {
        const templateList = document.getElementById('template-list');
        templateList.innerHTML = '';
        if (templates.length === 0) {
          templateList.innerHTML = '<li style="color: #888;">No templates saved yet.</li>';
          return;
        }
    
        templates.forEach(template => {
          const item = document.createElement('li');
          item.innerHTML = `
            <strong>${template.name}</strong>
            <p>${template.content}</p>
            <button onclick="editTemplate('${template.id}')">Edit</button>
            <button class="danger" onclick="deleteTemplate('${template.id}')">Delete</button>
          `;
          templateList.appendChild(item);
        });
      }
    
      window.saveTemplate = async function () {
        const name = document.getElementById('template-name').value;
        const content = document.getElementById('template-content').value;
        const saveBtn = document.querySelector('#templates button:not(.danger)');
    
        if (!name || !content) return alert('Please fill all fields');
    
        saveBtn.disabled = true;
        saveBtn.textContent = editingTemplateId ? 'Updating...' : 'Saving...';
    
        if (editingTemplateId) {
          await setDoc(doc(db, "templates", editingTemplateId), { name, content });
          const index = templates.findIndex(t => t.id === editingTemplateId);
          templates[index] = { id: editingTemplateId, name, content };
          editingTemplateId = null;
        } else {
          const docRef = await addDoc(collection(db, "templates"), { name, content });
          templates.push({ id: docRef.id, name, content });
        }
    
        loadTemplates();
        clearTemplateForm();
    
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Template';
      }
    
      window.clearTemplateForm = function () {
        document.getElementById('template-name').value = '';
        document.getElementById('template-content').value = '';
        editingTemplateId = null;
        document.querySelector('#templates button:not(.danger)').textContent = 'Save Template';
      }
    
      window.editTemplate = function (templateId) {
        const template = templates.find(t => t.id === templateId);
        if (!template) return;
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-content').value = template.content;
        editingTemplateId = template.id;
        document.querySelector('#templates button:not(.danger)').textContent = 'Update Template';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    
      window.deleteTemplate = async function (templateId) {
        if (confirm('Are you sure you want to delete this template?')) {
          await deleteDoc(doc(db, "templates", templateId));
          templates = templates.filter(t => t.id !== templateId);
          loadTemplates();
        }
      }
    
      function formatDate(timestamp) {
          if (!timestamp?.toDate) return '';
          const date = timestamp.toDate();
          const d = String(date.getDate()).padStart(2, '0');
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const y = date.getFullYear();
          
          // Get hours in 12-hour format
          let h = date.getHours();
          const ampm = h >= 12 ? 'pm' : 'am';
          h = h % 12;
          h = h ? h : 12; // Convert 0 to 12
          
          const min = String(date.getMinutes()).padStart(2, '0');
          
          // Return HTML with date and time on separate lines
          return `<div class="date-time-cell">
                    <div class="date-part">${d}/${m}/${y}</div>
                    <div class="time-part">${h}:${min}${ampm}</div>
                  </div>`;
      }

      let historyRecords = [];

      async function loadHistory() {
        const querySnapshot = await getDocs(collection(db, "notifications"));
        historyRecords = []; // Clear existing records
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          historyRecords.push(data); // Save each record
        });

        renderHistoryTable(historyRecords); // Initial render
      }

      function renderHistoryTable(dataArray) {
          const historyTable = document.getElementById('history-table');
          historyTable.innerHTML = '';

          if (dataArray.length === 0) {
            historyTable.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">No history available.</td></tr>';
            return;
          }

          dataArray.forEach(data => {
            const date = data.createdAt?.toDate?.();
            
            // Capitalize the role name first letter
            let role = data.role || '';
            role = role.charAt(0).toUpperCase() + role.slice(1).toLowerCase();

            // Assign roleClass based on the role
            let roleClass = '';
            if (role === 'User') {
              roleClass = 'status-user';  // Purple color for User
            } else if (role === 'Collector') {
              roleClass = 'status-collector';  // Blue color for Collector
            }

            const row = document.createElement('tr');
            row.setAttribute('data-timestamp', date?.toISOString() || '');
            row.innerHTML = `
              <td>${formatDate(data.createdAt)}</td>
              <td class="${roleClass}">${role}</td>
              <td>${data.message}</td>
            `;
            historyTable.appendChild(row);
          });
      }

    
      window.filterByDateRange = function () {
          const startInput = document.getElementById('start-date').value;
          const endInput = document.getElementById('end-date').value;
          const roleFilter = document.getElementById('role-filter').value; // Get selected role from the dropdown

          const start = startInput ? new Date(startInput) : null;
          const end = endInput ? new Date(endInput) : null;
          if (end) end.setHours(23, 59, 59, 999); // Set end time to the last moment of the day

          // Filter records based on both date range and selected role
          const filtered = historyRecords.filter(record => {
              const date = record.createdAt?.toDate?.();
              const role = record.role || '';  // Get role or default to an empty string
              const roleMatches = !roleFilter || role.toLowerCase() === roleFilter.toLowerCase();  // Compare role in lowercase

              // If the date doesn't match the filter or the role doesn't match, skip this record
              const withinDateRange = (!start || date >= start) && (!end || date <= end);

              return withinDateRange && roleMatches;
          });

          renderHistoryTable(filtered);
      };



    
      window.filterHistory = function () {
          const searchText = document.getElementById('history-search').value.toLowerCase();
          const startInput = document.getElementById('start-date').value;
          const endInput = document.getElementById('end-date').value;
          const roleFilter = document.getElementById('role-filter').value;

          const start = startInput ? new Date(startInput) : null;
          const end = endInput ? new Date(endInput) : null;
          if (end) end.setHours(23, 59, 59, 999); // Set end time to the last moment of the day

          const filtered = historyRecords.filter(record => {
              // Date filter
              const date = record.createdAt?.toDate?.();
              const withinDateRange = (!start || date >= start) && (!end || date <= end);
              
              // Role filter
              const role = record.role || '';
              const roleMatches = !roleFilter || role.toLowerCase() === roleFilter.toLowerCase();
              
              // Text search
              const message = record.message?.toLowerCase() || '';
              const textMatches = !searchText || message.includes(searchText);
              
              return withinDateRange && roleMatches && textMatches;
          });

          renderHistoryTable(filtered);
      };

    
      window.clearFilters = function () {
        // Clear input fields
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        document.getElementById('history-search').value = '';
        document.getElementById('role-filter').value = '';  // Reset the role filter

        // Re-render the full table from the raw data
        renderHistoryTable(historyRecords);
      };



    </script>

    <script src="./index.js"></script>


    

    <!-- ðŸ§  Standalone Tab Switch Script -->
    <script>
      function openTab(event, tabId) {
        // Hide or show saved templates based on the active tab
        if (tabId === 'history') {
          document.getElementById('saved-templates-container').style.display = 'none';
        } else if (tabId === 'templates') {
          document.getElementById('saved-templates-container').style.display = 'block';
        }

        // Hide all tab content and remove the active class from all tabs
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        
        // Show the selected tab and mark it as active
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
      }
    </script>
</body>
</html>